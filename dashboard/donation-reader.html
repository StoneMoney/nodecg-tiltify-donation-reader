<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<style>
		.monospace {
			font-family: monospace;
		}

		.card {
			box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
			transition: 0.3s;
		}

		.container {
			padding: 2px 16px;
		}

		.teal,
		.hover-teal:hover {
			color: #fff !important;
			background-color: #009688 !important
		}

		.gold {
			background-color: #fcad23 !important;
		}

		.btn,
		.button {
			border: none;
			display: inline-block;
			padding: 8px 16px;
			vertical-align: middle;
			overflow: hidden;
			text-decoration: none;
			color: inherit;
			background-color: inherit;
			text-align: center;
			cursor: pointer;
			white-space: nowrap
		}

		.block {
			display: block;
			width: 100%;
		}

		.stats-row {
			display: grid;
			grid-template-columns: 1fr 1fr 1fr;
		}

		.stats-card {
			margin: 8px;
			padding: 8px;
			border: 1px solid black;
			border-radius: 8px;
			box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
			transition: 0.3s;
		}
		h2, .stats-card h4 {
			margin-top: 4px;
			margin-bottom: 0px;
		}
		.donation-reader {
			display: grid;
			grid-template-rows: auto auto 1fr;
			max-height: 95vh;
		}
	</style>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
</head>

<body>
	<div class="donation-reader">

		<div class="stats-row">
			<div class="stats-card">
				Total Raised
				<h2 id="total-raised">LOADING!</h2>
				<h4 id="last-hour">???</h4>
			</div>
			<div class="stats-card">
				Total Donations
				<h2 id="total-donations">???</h2>
				<h4 id="dollars-per">???</h4>
			</div>
			<div class="stats-card">
				Unread Donations
				<h2 id="unread-donations">???</h2>
				<h4 id="update">???</h4>
			</div>
		</div>
		<div class="col-sm">
			<p>
				<button class="btn teal block" id="clear-donations" href="#" role="button">Clear Donation Queue</button>
			</p>
		</div>
		<div style="overflow-y: scroll;">
			<div class="col-sm-12" id="goals"></div>
			<div class="col-sm-12" id="donations">
			</div>
		</div>
	</div>

	<script>
		Date.prototype.addHours = function(h) { 
            this.setTime(this.getTime() + (h*60*60*1000)); 
            return this; 
        }
		var donations = [];
		var goals = [];
		var donationRep = nodecg.Replicant("donations", "nodecg-tiltify");
		var totalRep = nodecg.Replicant("total", "nodecg-tiltify");
		var goalRep = nodecg.Replicant("incentives", "nodecg-starbar");
		const HOUR = 60 * 60 * 1000;
		NodeCG.waitForReplicants(donationRep, goalRep, totalRep).then(() => {
			goalRep.on("change", function (newvalue, oldvalue) {
				goals = [...goalRep.value]
				goals = goals.map((goal, i) => {
					goal.id = i
					return goal;
				})
				goals = goals.filter((goal) => (goal.type === "milestone" || goal.type === "goal") && goal.shown)
				$("#goals").empty();
				for (let i = 0; i < goals.length; i++) {
					if (goals[i].read) {
						continue;
					}
					$("#goals").append("<div class=\"card\" id=\"goal-row-" + goals[i].id + "\"><div class=\"container\" style=\"border: rgb(82, 95, 120); border-radius: 12px; border-style: groove;\"><h2 id=\"name\"></h2><p id=\"message\"></p><p><button class=\"btn gold block\" id=\"goal-button-" + goals[i].id + "\" href=\"#\" role=\"button\">Mark as complete</button></p></div></div>");
					const row = $("#goal-row-" + goals[i].id);
					row.find("#name").text(`${goals[i].what} ${goals[i].type} achieved ($${goals[i].amount})`);
					row.find("#goal-button-" + goals[i].id).click(function () {
						const goalRepTemp = [...goalRep.value]
						goalRepTemp.splice(goals[i].id, 1);
						goalRep.value = goalRepTemp
					});
				}
			});
			totalRep.on("change", function (newvalue, oldvalue) {
				$("#total-raised").text(toUSD(newvalue))
			});
			donationRep.on("change", function (newvalue, oldvalue) {
				donations = newvalue;
				$("#donations").empty();
				let unreadCount = 0;
				let raisedLastHour = 0;
				$("#total-donations").text(newvalue.length)
				$("#dollars-per").text(toUSD(totalRep.value/newvalue.length) + " avg per dono")
				let hourAgo = new Date()
				$("#update").text("Last updated: "+hourAgo.toLocaleTimeString())
				hourAgo.addHours(-1)
				for (let i = 0; i < newvalue.length; i++) {
					if ((newvalue[i].completedAt - hourAgo.getTime()) > HOUR) {
						continue;
					}
					raisedLastHour+=newvalue[i].amount
				}
				$("#last-hour").text(toUSD(raisedLastHour)+" in the last hour")
				for (let i = 0; i < newvalue.length; i++) {
					if (newvalue[i].read) {
						continue;
					}
					unreadCount++;
					$("#donations").append("<div class=\"card\" id=\"donation-row-" + newvalue[i].id + "\"><div class=\"container\" style=\"border: rgb(82, 95, 120); border-radius: 12px; border-style: groove;\"><h2 id=\"name\"></h2><div id=\"time\"></div><p id=\"message\"></p><p><button class=\"btn teal block\" id=\"button-" + newvalue[i].id + "\" href=\"#\" role=\"button\">Mark as read</button></p></div></div>");
					const row = $("#donation-row-" + newvalue[i].id);
					row.find("#name").text(`${newvalue[i].name} donated $${newvalue[i].amount.toFixed(2)}`);
					row.find("#time").text(new Date(newvalue[i].completedAt).toLocaleTimeString())
					if (newvalue[i].comment != undefined) {
						row.find("#message").text(newvalue[i].comment);
					} else {
						row.find("#message").text("No Message");
					}
					row.find("#button-" + newvalue[i].id).click(function () {
						nodecg.sendMessageToBundle('mark-donation-as-read', 'nodecg-tiltify', newvalue[i]);
					});
				}
				$("#unread-donations").text(unreadCount);
			});
		});
		$("#clear-donations").click(function () {
			var confirmClear = confirm("Are you sure you want to clear all donations?")
			if (confirmClear == true) {
				nodecg.sendMessageToBundle('clear-donations', 'nodecg-tiltify');
			}
		});
		function toUSD(input) {
			return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(parseFloat(input))
		}
	</script>
</body>

</html>